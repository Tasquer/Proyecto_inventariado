{% extends "base.html" %} 
{% load static %} 

{% block title %}Dashboard de Inventario{% endblock %} 

{% block content %}
<style>
  /* Estilos personalizados ligeros para complementar Bootstrap */
  body {
    background-color: #f8f9fa; /* Un gris un poco más claro y moderno */
  }
  
  .table-hover tbody tr:hover {
    background-color: rgba(13, 110, 253, 0.05); /* Hover azul muy suave */
    transition: background-color 0.2s ease-in-out;
  }

  .sort-pill {
    border-radius: 50rem;
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
    transition: all 0.2s;
    border: 1px solid #dee2e6;
    background-color: white;
    color: #495057;
    text-decoration: none;
    margin-right: 0.5rem;
    margin-bottom: 0.5rem;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }

  .sort-pill:hover {
    background-color: #e9ecef;
    color: #212529;
  }

  .sort-pill.active {
    background-color: #0d6efd;
    color: white;
    border-color: #0d6efd;
  }

  .empty-state-icon {
    font-size: 4rem;
    color: #adb5bd;
  }
</style>

<div class="container py-4">
  
  <div class="row mb-4 align-items-center g-3">
    <div class="col-md-6">
        <h2 class="fw-bold text-dark mb-0">Inventario</h2>
        <p class="text-muted small mb-0">Gestiona tus productos y existencias</p>
    </div>
    <div class="col-md-6 text-md-end">
        <a href="{% url 'productos:crear' %}" class="btn btn-primary shadow-sm">
            <i class="bi bi-plus-lg me-1"></i> Nuevo Producto
        </a>
    </div>
  </div>

  <div class="card shadow-sm mb-4 border-0">
    <div class="card-body bg-white rounded">
      <form method="get" class="row g-3 align-items-center">
        <div class="col-md-8 col-lg-6">
          <div class="input-group">
            <span class="input-group-text bg-light border-end-0">
                <i class="bi bi-search text-muted"></i>
            </span>
            <input
              class="form-control border-start-0 bg-light"
              type="search"
              placeholder="Buscar por nombre, SKU o categoría..."
              name="q"
              value="{{ search_query|default:'' }}"
            />
            <input type="hidden" name="sort_by" value="{{ current_sort_by }}">
            <button class="btn btn-outline-secondary" type="submit">Buscar</button>
          </div>
        </div>

        <div class="col-md-4 col-lg-6 text-md-end">
            <button class="btn btn-light text-primary fw-medium" type="button" data-bs-toggle="collapse" data-bs-target="#filtrosCollapse" aria-expanded="false">
                <i class="bi bi-sliders me-1"></i> Ordenar y Filtrar
            </button>
        </div>
      </form>

      <div class="collapse mt-3 {% if current_sort_by %}show{% endif %}" id="filtrosCollapse">
        <hr class="text-muted opacity-25">
        <p class="small text-muted fw-bold text-uppercase ls-1 mb-2">Ordenar por:</p>
        <div class="d-flex flex-wrap">
            {% with base_url='?q='|add:search_query|default:'' %}
            <a href="{% url 'dashboard' %}{{ base_url }}&sort_by=recientes" class="sort-pill {% if current_sort_by == 'recientes' or not current_sort_by %}active{% endif %}">
                <i class="bi bi-clock-history"></i> Recientes
            </a>
            <a href="{% url 'dashboard' %}{{ base_url }}&sort_by=antiguos" class="sort-pill {% if current_sort_by == 'antiguos' %}active{% endif %}">
                <i class="bi bi-calendar"></i> Antiguos
            </a>
            <a href="{% url 'dashboard' %}{{ base_url }}&sort_by=nombre" class="sort-pill {% if current_sort_by == 'nombre' %}active{% endif %}">
                <i class="bi bi-sort-alpha-down"></i> Nombre (A-Z)
            </a>
            <a href="{% url 'dashboard' %}{{ base_url }}&sort_by=categoria" class="sort-pill {% if current_sort_by == 'categoria' %}active{% endif %}">
                <i class="bi bi-tag"></i> Categoría
            </a>
            <a href="{% url 'dashboard' %}{{ base_url }}&sort_by=stock" class="sort-pill {% if current_sort_by == 'stock' %}active{% endif %}">
                <i class="bi bi-box-seam"></i> Stock (Bajo)
            </a>
            {% endwith %}
            
            {% if search_query or current_sort_by %}
            <a href="{% url 'dashboard' %}" class="btn btn-link text-decoration-none btn-sm ms-auto text-danger">
                <i class="bi bi-x-circle"></i> Limpiar filtros
            </a>
            {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm border-0">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th scope="col" class="ps-4 py-3">Producto</th>
              <th scope="col">Categoría</th>
              <th scope="col">Stock</th>
              <th scope="col">Estado / Caducidad</th>
              <th scope="col" class="text-end pe-4">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for producto in productos %}
            <tr>
              <td class="ps-4 fw-medium text-dark">
                  {{ producto.nombre }}
              </td>
              <td>
                  <span class="badge bg-light text-dark border">
                      {{ producto.categoria.nombre }}
                  </span>
              </td>
              <td>
                {% if producto.cantidad <= 5 %}
                    <span class="text-danger fw-bold"><i class="bi bi-exclamation-circle-fill"></i> {{ producto.cantidad }}</span>
                {% else %}
                    <span class="text-dark">{{ producto.cantidad }}</span>
                {% endif %}
              </td>
              <td>
                {% if producto.fecha_caducidad %}
                    <div class="d-flex flex-column">
                        <span class="small {% if producto.fecha_caducidad < today %}text-danger fw-bold{% else %}text-muted{% endif %}">
                            <i class="bi bi-calendar-event me-1"></i>
                            {{ producto.fecha_caducidad|date:"d M, Y" }}
                        </span>
                        {% if producto.fecha_caducidad < today %}
                            <span class="badge bg-danger-subtle text-danger border border-danger-subtle mt-1" style="width: fit-content;">Caducado</span>
                        {% endif %}
                    </div>
                {% else %}
                    <span class="text-muted small">Does not expire</span>
                {% endif %}
              </td>
              <td class="text-end pe-4">
                <div class="btn-group" role="group">
                    <a href="{% url 'productos:editar' producto.pk %}" class="btn btn-sm btn-outline-primary" title="Editar">
                        <i class="bi bi-pencil"></i>
                    </a>
                    <a href="{% url 'productos:eliminar' producto.pk %}" class="btn btn-sm btn-outline-danger" title="Eliminar">
                        <i class="bi bi-trash"></i>
                    </a>
                </div>
              </td>
            </tr>
            
            {% empty %}
            <tr>
              <td colspan="5" class="text-center py-5">
                <div class="py-4">
                    <i class="bi bi-box-seam empty-state-icon mb-3 d-block"></i>
                    <h4 class="text-muted fw-normal">No se encontraron productos</h4>
                    <p class="text-muted mb-4">
                        {% if search_query %} 
                            No hay resultados para "<strong>{{ search_query }}</strong>". Intenta con otra búsqueda.
                        {% else %} 
                            Tu inventario está vacío. Comienza agregando stock.
                        {% endif %}
                    </p>
                    <a href="{% url 'productos:crear' %}" class="btn btn-primary">
                        <i class="bi bi-plus-lg"></i> Agregar primer producto
                    </a>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    <div class="card-footer bg-white border-top-0 py-3">
        <small class="text-muted">Mostrando {{ productos|length }} productos</small>
    </div>
  </div>
</div>
{% endblock %}